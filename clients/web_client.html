<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTSè¯­éŸ³åˆæˆå®¢æˆ·ç«¯</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .container { max-width: 800px; margin: 0 auto; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        .controls { margin: 20px 0; }
        textarea { width: 100%; height: 100px; margin: 10px 0; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .audio-controls { margin: 20px 0; }
        .log { background: #f8f9fa; padding: 10px; height: 200px; overflow-y: auto; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸµ æµå¼è¯­éŸ³åˆæˆå®¢æˆ·ç«¯</h1>

        <div class="status" id="status">æœªè¿æ¥</div>

        <div class="controls">
            <textarea id="textInput" placeholder="è¯·è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬..."></textarea>
            <br>
            <button onclick="connect()">è¿æ¥æœåŠ¡</button>
            <button onclick="disconnect()">æ–­å¼€è¿æ¥</button>
            <button onclick="synthesize()">å¼€å§‹åˆæˆ</button>
            <button onclick="stopPlayback()">åœæ­¢æ’­æ”¾</button>
        </div>

        <div class="audio-controls">
            <audio id="audioPlayer" controls style="width: 100%;"></audio>
        </div>

        <div>
            <h3>æ—¥å¿—è¾“å‡º</h3>
            <div class="log" id="log"></div>
        </div>
    </div>

    <script>
        let websocket = null;
        let audioChunks = [];
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let audioQueue = [];
        const audioPlayer = document.getElementById('audioPlayer');

        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}<br>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateStatus(connected) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = connected ? 'å·²è¿æ¥åˆ°TTSæœåŠ¡' : 'æœªè¿æ¥';
            statusElement.className = 'status ' + (connected ? 'connected' : 'disconnected');
        }

        async function connect() {
            try {
                const host = window.location.hostname || 'localhost';
                const port = 8765;
                websocket = new WebSocket(`ws://${host}:${port}`);

                websocket.onopen = function() {
                    updateStatus(true);
                    log('WebSocketè¿æ¥å·²å»ºç«‹');
                };

                websocket.onmessage = async function(event) {
                    const data = JSON.parse(event.data);
                    log(`æ”¶åˆ°æ¶ˆæ¯: ${data.type}`);

                    if (data.type === 'audio_chunk') {
                        await handleAudioChunk(data);
                    } else if (data.type === 'synthesis_complete') {
                        log(`åˆæˆå®Œæˆï¼Œæ€»å…± ${data.total_chunks} ä¸ªæ•°æ®å—`);
                        try {
                            const blob = new Blob(audioChunks, { type: 'audio/wav' });
                            const url = URL.createObjectURL(blob);
                            audioPlayer.src = url;
                            await audioPlayer.play();
                            log('å¼€å§‹æ’­æ”¾åˆæˆéŸ³é¢‘');
                        } catch (e) {
                            log('æ’­æ”¾éŸ³é¢‘å¤±è´¥: ' + e);
                        }
                    } else if (data.type === 'error') {
                        log(`é”™è¯¯: ${data.message}`);
                    }
                };

                websocket.onclose = function() {
                    updateStatus(false);
                    log('WebSocketè¿æ¥å·²å…³é—­');
                };

                websocket.onerror = function(error) {
                    log('WebSocketé”™è¯¯: ' + error);
                };

            } catch (error) {
                log('è¿æ¥å¤±è´¥: ' + error);
            }
        }

        async function handleAudioChunk(data) {
            try {
                const audioData = Uint8Array.from(atob(data.audio_data), c => c.charCodeAt(0));
                audioChunks.push(audioData);
                log(`æ”¶åˆ°éŸ³é¢‘å— ${data.chunk_index}, å¤§å°: ${data.chunk_size} å­—èŠ‚`);
            } catch (error) {
                log('å¤„ç†éŸ³é¢‘æ•°æ®é”™è¯¯: ' + error);
            }
        }

        function disconnect() {
            if (websocket) {
                websocket.close();
                websocket = null;
            }
        }

        function synthesize() {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                log('è¯·å…ˆè¿æ¥åˆ°TTSæœåŠ¡');
                return;
            }

            const text = document.getElementById('textInput').value.trim();
            if (!text) {
                log('è¯·è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬');
                return;
            }

            audioChunks = [];
            if (audioPlayer.src) {
                URL.revokeObjectURL(audioPlayer.src);
                audioPlayer.removeAttribute('src');
            }
            audioPlayer.pause();

            const request = {
                type: 'synthesize',
                request_id: 'req_' + Date.now(),
                text: text
            };

            websocket.send(JSON.stringify(request));
            log('å·²å‘é€åˆæˆè¯·æ±‚');
        }

        function stopPlayback() {
            if (audioPlayer) {
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
            }
            log('æ’­æ”¾å·²åœæ­¢');
        }

        // é¡µé¢å¸è½½æ—¶å…³é—­è¿æ¥
        window.addEventListener('beforeunload', function() {
            if (websocket) {
                websocket.close();
            }
        });
    </script>
</body>
</html>